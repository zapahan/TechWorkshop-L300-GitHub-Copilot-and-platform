---
title: '2. Prevent secrets from being stored in code'
layout: default
nav_order: 2
parent: 'Exercise 04: Secure development with GitHub Advanced Security'
---

# Task 02 - Prevent secrets from being stored in code

## Description

GitHub Advanced Security includes secret scanning. In this task you will see how your security configuration prevents secrets from being introduced into a GitHub repository.

## Success Criteria

- You have prevented secrets from being added to your repository

## Learning Resources

## Key Tasks

### 01: Verify secret scanning pattern configurations

In the previous task you configured GitHub Advanced Security for the organization. In this task you will verify the secret pattern configurations before attempting to block secrets being committed to the repository.

Go to the Advanced Security settings for the organization and review the secret scanning push protection patterns and configuration. Note that most settings are set to inherit GitHub defaults, many of which are enabled. For this task you will enable explicitly the `Stripe Test API Secret Key` pattern.


<details markdown="block">
<summary><strong>Expand this section to see detailed steps</strong></summary>

1. Navigate to your organization on GitHub online and select the Settings tab. From the left menu select Advanced Security -> Global Settings.

2. Select the Secret scanning menu and in the Push protection section, select the configuration icon to review pattern configurations.
![Global settings for secret scanning patterns](../../media/0501_global_secret_patterns.png)

3. Select the Name filter and enter: `name:stripe` to filter the list.
![Filtering secret patterns](../../media/0501_global_secret_patterns_1.png)

4. Enable the `Stripe Test API Secret Key` pattern.
![Enabling a secret pattern explicitly](../../media/0501_global_secret_patterns_2.png)

</details>

### 02: Add secrets to the solution

To review how GitHub security settings related to secrets works, you will add one or more secrets to the solution code.

1. Go to the solution in Visual Studio Code.

2. Open the `src/appsettings.json` file. Add the following settings (secrets) and save the changes:

```json
      "secrets": {
    "users": [
      { "username": "admin", "password": "XXX" }
    ],
    "database": {
      "connectionString": "Server=tcp:zavadbserver.database.windows.net,1433;Initial Catalog=zavadb;Persist Security Info=False;User ID=sa;Password=XXX;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
      }
  }
```

You will replace `XXX` with `secret` when you paste it into the code.

3. Open the `/src/Controllers/CartController.cs` file. Add the following variables (secrets) to the class and save the changes:

```chsharp
   public class CartController : Controller
    {

        string stripe_key = "ZZZZokikJOvBiI2HlWgH4olfQ2";
        string admin_password = "XXX";

        ...
    }
```
You will replace `ZZZZ` with `sk_test_BQ` when you paste it into the code.

> **NOTE** GitHub scans the entire repository and since the documentation also is scanned the secrets cannot be placed in the documents or they become part of GitHub commit history and will either prevent you from pushing changes, or be picked up by the Dependabot scans.

### 03: Try to commit the changes

In this task you will observe GitHub Advanced Security settings preventing you from committing code that contains detected secrets.

Commit the changes from the previous task and push them to your current branch. As you push you should see an error rejecting the Stripe API key from the commit:

```bash
! [remote rejected] docs -> docs (push declined due to repository rule violations)
error: failed to push some refs to 'https://github.com/zava-ai-lab/zava-ai-devops-copilot.git'
```
This works because you have the organization setup for secrets protection.
![GitHub organization secrets configuration](../../media/0402_secrets_config.png)

<details markdown="block">
<summary><strong>Expand this section to see detailed steps</strong></summary>

From Terminal, issue the commands to add your changes and commit:

```bash
git add .
git commit -m 'adding secrets'
git push
```

The output, after you attempt to push, should be similar to the following:

```bash
remote: error: GH013: Repository rule violations found for refs/heads/docs.
remote:
remote: - GITHUB PUSH PROTECTION
remote:   —————————————————————————————————————————
remote:     Resolve the following violations before pushing again
remote:
remote:     - Push cannot contain secrets
remote:
remote:
remote:      (?) Learn how to resolve a blocked push
remote:      https://docs.github.com/code-security/secret-scanning/working-with-secret-scanning-and-push-protection/working-with-push-protection-from-the-command-line#resolving-a-blocked-push
remote:
remote:
remote:       —— Stripe Test API Secret Key ————————————————————————
remote:        locations:
remote:          - commit: 51ff6b29cc5ed9b67287f50a04b6792a6208f669
remote:            path: src/Controllers/CartController.cs:8
remote:          - commit: e156fefac93afc71b38a503ef935e2ce0581522c
remote:            path: src/Controllers/CartController.cs:10
remote:
remote:        (?) To push, remove secret from commit(s) or follow this URL to allow the secret.
remote:        https://github.com/zava-ai-lab/zava-ai-devops-copilot/security/secret-scanning/unblock-secret/35A2vGmTz1y1ZUXYGXVVVF6e7zq
remote:
 ! [remote rejected] docs -> docs (push declined due to repository rule violations)
error: failed to push some refs to 'https://github.com/zava-ai-lab/zava-ai-devops-copilot.git'

```
</details>

### 04: Remove the secrets from the solution code and local commits

You will now delete the `stripe_key` variable from `src/Controllers/CartController.cs`. If any other secrets were listed as blocking, remove those as well. Save the changes and try once again to commit and push the changes to your current branch.

You will still see the message indicating the push is rejected. This time it is because the commit history still includes the secrets. To fix this you should reset the commit history to match the remote branch (eg. `origin/<your_branch_name>`). Now your local branch has reverted the secret changes.

<details markdown="block">
<summary><strong>Expand this section to see detailed steps</strong></summary>

1. In Visual Studio Code, open the `src/Controllers/CartController.cs` file and remove the `stripe_key` variable that was listed as rejecting the push command.

2. From Terminal, issue the commands to add your changes and commit:

```bash
git add .
git commit -m 'adding secrets'
git push
```

This step will fail since the commit history still has the secret.

3. Reset the commit history to remove the secrets with the following command:

```bash
git reset --hard origin/<your_branch_name>
```
Once you have done this, you will be able to push changes to this branch so long as there are no secrets remaining in the code.
</details>

### 05: Review secret scanning alerts

Not all secrets are rejected from pushing to the repository based on the configured secret patterns, however, secret scans will still discover those after they are pushed to the repository. Go to your repository at GitHub online and navigate to Vulnerability alerts under the Security tab. Review the alerts and you will see the results of previous scans.

> **NOTE** Since the secrets have entered the repository, they are no longer safe. You have to explicitly close the alert and indicate how you have mitigated the concern such as revoking the key from use in your solution.

<details markdown="block">
<summary><strong>Expand this section to see detailed steps</strong></summary>

1. Navigate to the Security tab for the repository. Select the Secret scanning menu under Vulnerability alerts.

2. Select Default alerts and it will show the API keys that were not rejected by the repository push.
![Default secret scanning alerts](../../media/0402_secret_alerts_default.png)

3. Select Generic alerts and it will show secrets that were not rejected by the repository push.
![Generic secret scanning alerts](../../media/0402_secret_alert_generic.png)

4. Select one of the alerts so you can close it. Choose a close reason from the list.
![Closing a secret alert](../../media/0501_close_alert.png)

5. Based on your notification settings, you may also receive email alerts.
![Alert emails](../../media/0501_alert_email.png)

## Summary

You've completed this task. You have prevented secrets from being added to your repository and reviewed secret scanning alerts.
