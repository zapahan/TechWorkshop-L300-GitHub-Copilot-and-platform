---
title: '1. Add Custom AI Telemetry'
layout: default
nav_order: 1
parent: 'Exercise 06: AI Governance and Model Observability'
---

# Task 01 - Add Custom AI Telemetry

## Description

In this task, you will instrument the application’s chat completion endpoint to emit custom Application Insights telemetry for AI model performance and usage.
You’ll add lightweight tracking that captures the model version, latency, and completion result for each request.
This data enables downstream analysis in Log Analytics, workbooks, and alert rules created later in the lab—providing the foundation for AI observability and governance.

## Success Criteria

- The application successfully records custom events named ChatCompletion in Application Insights.
- Each event includes the following properties:

  - ModelVersion (string)

  - CompletionLatencyMs (numeric metric)

  - CompletionResult (string or truncated text)

- Querying the workspace with

    ```kusto
    AppEvents | where Name == "ChatCompletion" | take 5
    ```

    returns results containing Properties and Measurements columns populated with these values.

## Learning Resources

- [Application Insights custom events and metrics (Microsoft Docs)](https://learn.microsoft.com/azure/azure-monitor/app/api-custom-events-metrics)
- [Azure Monitor Logs: Kusto Query Language (KQL) quick reference](https://learn.microsoft.com/azure/data-explorer/kql-quick-reference)
- [TelemetryClient class reference (.NET)](https://learn.microsoft.com/dotnet/api/microsoft.applicationinsights.telemetryclient)
- [Azure Monitor overview](https://learn.microsoft.com/azure/azure-monitor/overview)

## Key Tasks

### 01: Add Custom AI Telemetry

Use Copilot Chat in VS Code to request instrumentation of the chat completion endpoint to record:
* `ModelVersion`
* `CompletionLatencyMs`
* `CompletionResult`

Try this prompt to get started with CoPilot:

```text
/agent instrument the chat completion endpoint to record custom Application Insights
telemetry: ModelVersion, CompletionLatencyMs, and CompletionResult. We are interested in
the simplest possible solution that will allow us to measure AI performance and usage.
```

![Add Custom AI Telemetry](../../media/06_01-telemetry-prompt.png)

<details markdown="block">
<summary>Show example implementation (C#)</summary>

Minimal .NET pattern:

```csharp
var sw = Stopwatch.StartNew();
var response = await model.GetChatCompletionAsync(input);
sw.Stop();

telemetry.TrackMetric("CompletionLatencyMs", sw.ElapsedMilliseconds);
telemetry.TrackEvent(
    "ChatCompletion",
    new Dictionary<string, string>
    {
        { "ModelVersion", model.Version },
        { "CompletionResult", response.Result }
    });
```

</details>

Deploy or run locally, then confirm events appear: Application Insights → Logs → run a Kusto query (next task). No unit tests required for this exercise.

### 02: Verify Telemetry Ingestion

1. In the Azure Portal, navigate to your Log Analytics Workspace (created in earlier exercises).

2. Select Overview in the left navigation.

3. Copy the value labeled Workspace ID — this is the GUID you’ll use for `$LOG_ANALYTICS_ID`.

4. Then run the following command from the VS Code terminal:

```bash
az monitor log-analytics query \
  --workspace $LOG_ANALYTICS_ID \
  --analytics-query "AppEvents | where Name == 'ChatCompletion' | take 5" \
  -o table
```

You should see `Properties` (custom dimensions) and `Measurements` (metrics). If only heartbeat events appear, ensure you are not creating multiple `TelemetryClient` instances.


###  Troubleshooting Notes

If your telemetry query doesn’t return results or commands fail, try asking **GitHub Copilot Chat** to help you troubleshoot.

<details markdown="block">
<summary>Below are sample prompts you can run directly in VS Code</summary>

| Symptom                                                            | Possible Cause                                                                                         | Example Copilot Prompt                                                                                                                                     |
| ------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| No `ChatCompletion` events appear in Application Insights          | The app may be creating multiple `TelemetryClient` instances or not sending telemetry before shutdown. | `/explain why my custom telemetry events are not showing up in Application Insights. Here is the TelemetryClient code. Suggest fixes.`                     |
| CLI returns `az monitor logs query: error: unrecognized arguments` | The **Log Analytics CLI extension** isn’t installed.                                                   | `/explain this Azure CLI error: 'az monitor logs query: unrecognized arguments'. Suggest how to run a workspace-based query for Application Insights.`     |
| `az monitor app-insights query` fails with `AADSTS 501051`         | Service principal authentication isn’t supported for the App Insights data-plane API.                  | `/explain why az monitor app-insights query fails with AADSTS 501051 when running in GitHub Actions. Suggest an alternative command that works with RBAC.` |
| Query runs but shows no data                                       | Data ingestion delay or wrong workspace ID.                                                            | `/help me verify that my workspace ID is correct and telemetry data is flowing from Application Insights to Log Analytics.`                                |

**Tip:** Copilot can also run the `az` commands for you through the Azure MCP if configured, allowing you to iterate interactively until you see valid telemetry results.

</details>

## Summary

You've completed this task. The application successfully records custom events named ChatCompletion in Application Insights with ModelVersion, CompletionLatencyMs, and CompletionResult properties.