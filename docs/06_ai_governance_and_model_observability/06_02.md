---
title: '2. Add Workbook and Alert'
layout: default
nav_order: 2
parent: 'Exercise 06: AI Governance and Model Observability'
---

# Task 02 - Add Workbook and Alert

## Description

In this task you will expand your observability infrastructure by adding a Workbook to visualize latency and a Scheduled Query Rule alert to detect high latency in your AI service.
You will use Bicep (via Azure MCP + Copilot) to declaratively deploy a workbook tied to your workspace and an alert rule that triggers when average inference latency exceeds a threshold for a specified time window.

## Success Criteria

- A workbook resource of type `Microsoft.Insights/workbooks` appears in the resource group, with queries visualizing `CompletionLatencyMs` by `ModelVersion`. ([learn.microsoft.com](https://learn.microsoft.com/en-us/azure/templates/microsoft.insights/workbooks))
- An alert rule resource of type `Microsoft.Insights/scheduledQueryRules` (or equivalent) is deployed, scoped to the Application Insights workspace, and triggers when average latency > 2000 ms for 5 minutes. ([learn.microsoft.com](https://learn.microsoft.com/en-us/rest/api/monitor/scheduled-query-rules/create-or-update?view=rest-monitor-2021-08-01))
- You can list the resources via CLI (`az monitor workbook list`, `az monitor scheduled-query list`) and open the workbook in the portal to confirm the visuals appear and the alert is enabled.

## Learning Resources

- [Azure Monitor Workbooks – Create or edit a workbook](https://learn.microsoft.com/en-us/azure/azure-monitor/visualize/workbooks-create-workbook)
- [Microsoft.Insights/workbooks resource type (Bicep / ARM)](https://learn.microsoft.com/en-us/azure/templates/microsoft.insights/workbooks)
- [Tutorial – Create a log search alert rule (Azure Monitor)](https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/tutorial-log-alert)
- [Scheduled Query Rules – Create or update (REST API)](https://learn.microsoft.com/en-us/rest/api/monitor/scheduled-query-rules/create-or-update)

## Key Tasks

### 01: Add Workbook and Alert (Bicep)

Prompt Copilot (Azure MCP):

> Update /infra to add a workbook to my Application Insights instance visualizing average `CompletionLatencyMs` by `ModelVersion` a line chart showing latency over time, and a column chart showing request throughput over time, and an alert when average latency > 2000 ms for 5 minutes.

![Add Workbook and Alert](../../media/06_02-workbook-prompt.png)

<details markdown="block">
<summary>Validated Bicep snippet</summary>

```bicep
@description('Resource ID of the Application Insights resource')
param appInsightsResourceId string

@description('Resource ID of the Log Analytics workspace')
param workspaceResourceId string

@description('Resource ID of the Action Group for alert notifications')
param actionGroupId string = ''

// Deploy Workbook for Chat Completion Observability
resource workbook 'Microsoft.Insights/workbooks@2023-06-01' = {
  name: guid(resourceGroup().id, 'workbook-chat-observability')
  location: resourceGroup().location
  kind: 'shared'
  properties: {
    displayName: 'Chat Completion Observability'
    category: 'workbook'
    sourceId: appInsightsResourceId
    serializedData: replace(loadTextContent('workbook-chat-observability.json'), '__APP_INSIGHTS_RESOURCE_ID__', appInsightsResourceId)
    version: 'Notebook/1.0'
  }
}

// Deploy Alert for High ChatCompletion Latency
resource alertChatLatencyHigh 'Microsoft.Insights/scheduledQueryRules@2025-01-01-preview' = {
  name: 'alert-chat-latency-high'
  location: resourceGroup().location
  properties: {
    description: 'Alert when avg CompletionLatencyMs > 2000 ms for 5 minutes'
    enabled: true
    scopes: [appInsightsResourceId]
    evaluationFrequency: 'PT5M'
    windowSize: 'PT5M'
    skipQueryValidation: false
    criteria: {
      allOf: [
        {
          query: 'customEvents | where name == "ChatCompletion" | extend LatencyMs = todouble(customMeasurements.CompletionLatencyMs) | summarize AvgLatencyMs = avg(LatencyMs) by bin(timestamp, 5m) | where AvgLatencyMs > 2000 | count'
          operator: 'GreaterThan'
          threshold: 0
          timeAggregation: 'Count'
        }
      ]
    }
    actions: {
      actionGroups: empty(actionGroupId) ? [] : [actionGroupId]
      customProperties: {
        emailSubject: 'AI ChatCompletion Latency Alert'
      }
    }
    severity: 2
  }
}
```

</details>

<details markdown="block">
<summary>Validated Workbook JSON snippet</summary>

```json
{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "Parameters/1.0",
        "parameters": [
          {
            "id": "timeRange",
            "name": "Time Range",
            "type": 4,
            "value": {
              "durationMs": 86400000
            },
            "label": "Time Range"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters - time range"
    },
    {
      "type": 1,
      "content": {
        "json": "## Chat Completion Latency by ModelVersion"
      },
      "name": "text - header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customEvents\n| where name == 'ChatCompletion'\n| extend ModelVersion = tostring(customDimensions.ModelVersion)\n| extend LatencyMs = todouble(customMeasurements.CompletionLatencyMs)\n| summarize avgLatency=avg(LatencyMs) by ModelVersion\n| order by avgLatency desc",
        "size": 0,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "query - latency"
    },
    {
      "type": 1,
      "content": {
        "json": "## Latency Over Time"
      },
      "name": "text - latency header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customEvents | where name == 'ChatCompletion' | extend LatencyMs = todouble(customMeasurements.CompletionLatencyMs) | summarize avgLatency=avg(LatencyMs) by bin(timestamp, 5m) | order by timestamp asc",
        "size": 0,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "linechart",
        "chartSettings": {
          "title": "Average Latency (ms)",
          "xAxisType": "dateTime",
          "yAxisType": "numeric",
          "xAxisColumn": "timestamp",
          "yAxisColumns": ["avgLatency"]
        }
      },
      "name": "query - latency over time"
    },
    {
      "type": 1,
      "content": {
        "json": "## Completion Requests Over Time"
      },
      "name": "text - requests header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customEvents | where name == 'ChatCompletion' | summarize RequestCount=count() by bin(timestamp, 5m) | order by timestamp asc",
        "size": 0,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "barchart",
        "chartSettings": {
          "title": "Request Count",
          "xAxisType": "dateTime",
          "yAxisType": "numeric",
          "xAxisColumn": "timestamp",
          "yAxisColumns": ["RequestCount"]
        }
      },
      "name": "query - requests over time"
    }
  ],
  "fallbackResourceIds": ["__APP_INSIGHTS_RESOURCE_ID__"],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
```

</details>

### 02: Provision Observability Resources

Since only infrastructure changed, run:

```bash
azd provision
```

Verify resources:

```bash
az monitor workbook list --resource-group rg-zava-ai-dev
az monitor scheduled-query list --resource-group rg-zava-ai-dev
```

### 03: Inspect Workbook and Alerts

For the verified example workbook:

Open Workbook: Portal → Application Insights → Workbooks → Chat Completion Observability.

![Workbook](../../media/06_02-workbook.png)

#### 1. Explore Workbook Visualizations

Your workbook should display sections resembling the descriptions below.

| Section                                 | Visualization | Description                                              |
| --------------------------------------- | ------------- | -------------------------------------------------------- |
| Chat Completion Latency by ModelVersion | Table         | Average latency per model version (selected time range). |
| Latency Over Time                       | Line chart    | Rolling average inference latency trend.                 |
| Completion Requests Over Time           | Column chart  | Event volume in 5‑minute bins.                           |

Use the time range selector to adjust scope (default is 24h).

#### 2. Validate Alert Rule

For the verified example alert:

Portal → Monitor → Alerts → filter by resource group.

Confirm `alert-chat-latency-high` exists. To force a trigger, temporarily add an intentional delay (e.g., `Thread.Sleep(3000)`), then wait ≥5 minutes for evaluation.

### Troubleshooting Notes — Workbook

If the workbook doesn’t show data or won’t deploy, try these Copilot prompts to diagnose quickly.

<details markdown="block">
<summary>Below are sample prompts you can run directly in VS Code</summary>

| Symptom                                                            | Likely Cause                                                            | Copilot Prompt                                                                                                                                     |
| ------------------------------------------------------------------ | ----------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| Workbook deploys but shows **no data**                             | Wrong table or classic (non-workspace) schema used                      | `/explain why my workbook shows no data. Here is the KQL I used. Map it to workspace-based tables and fix the query.`                              |
| Workbook **doesn’t appear under Application Insights → Workbooks** | `sourceId` bound to the workspace instead of the App Insights component | `/inspect this Bicep resource for Microsoft.Insights/workbooks and ensure sourceId targets the Application Insights component, not the workspace.` |
| Portal says **“Invalid workbook JSON”**                            | Bad `serializedData` JSON or missing escapes in Bicep string            | `/validate this serializedData JSON for a workbook and convert it into a properly escaped Bicep string literal.`                                   |
| Visuals render but **columns are empty**                           | KQL uses `customEvents` vs. `AppEvents` (or wrong property paths)       | `/rewrite this KQL for my workspace-based schema. I need ModelVersion from Properties and CompletionLatencyMs from Measurements.`                  |
| **RBAC/Permissions** error when opening workbook                   | Current user/service principal lacks read on App Insights or workspace  | `/generate the minimal RBAC assignments needed to view a workbook bound to an Application Insights component and its workspace.`                   |
| **Time range** shows empty charts                                  | Workbook default time range too narrow                                  | `/edit my workbook JSON to add a 24h time range parameter and wire it to all queries.`                                                             |

**Quick checks**
- Confirm the workbook is under **Application Insights → Workbooks** (not Monitor) and that `properties.sourceId` points to the App Insights resource.
- Verify queries reference workspace-based columns (e.g., `AppEvents` with `Properties` / `Measurements`) if you’re using the Log Analytics connector.
- If using the App Insights resource type queries, align with `customEvents`, `customDimensions`, and `customMeasurements`.

</details>

### Troubleshooting Notes — Alert Rule

If your alert doesn’t appear or fails to trigger, try these Copilot prompts to diagnose and repair configuration issues.

<details markdown="block">
<summary>Below are sample prompts you can run directly in VS Code</summary>

| Symptom                                                     | Likely Cause                                                                              | Copilot Prompt                                                                                                                                    |
| ----------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| Alert rule fails to deploy or shows a schema error          | Incorrect property names or queryType in Bicep (the schema differs between API versions)  | `/explain why my Microsoft.Insights/scheduledQueryRules resource fails to deploy. Validate property names and fix schema for 2022-11-01-preview.` |
| Alert never fires even with high latency                    | Query returns zero rows due to wrong field paths (`Measurements` vs `customMeasurements`) | `/help me debug why my scheduled query rule isn't triggering. Review this KQL and fix field references for workspace-based telemetry.`            |
| Alert fires continuously                                    | Threshold or operator misconfigured (e.g., `GreaterThan` vs `GreaterThanOrEqual`)         | `/inspect my Bicep alert definition and suggest correct trigger settings so it only fires when avg latency > 2000 ms.`                            |
| Alert rule created but **no notifications** received        | Action Group not connected or missing permission                                          | `/review this alert rule and action group configuration. Ensure aznsAction points to a valid action group and notifications are enabled.`         |
| Alert visible in portal but **disabled**                    | `enabled: false` in Bicep or no evaluation metric defined                                 | `/explain why my scheduledQueryRules alert shows disabled in portal. Suggest correct properties to enable and evaluate it.`                       |
| CLI command `az monitor scheduled-query list` returns empty | Deployed to a different resource group or region                                          | `/help me locate my scheduledQueryRules resource in Azure. List by subscription and region to confirm deployment location.`                       |

**Quick checks**
- Ensure `enabled: true` and `evaluationMetric: 'Count'` are present.
- Confirm `workspaceResourceId` points to the **Log Analytics workspace**, not Application Insights.
- Test the KQL manually in **Logs** to verify it produces results before the alert rule can evaluate them.
- Verify that your **Action Group** exists and has at least one notification action configured.

</details>

## Summary

You've completed this task. You have deployed an Application Insights Workbook that visualizes latency by model version and an Azure Monitor alert that triggers on sustained high completion latency.