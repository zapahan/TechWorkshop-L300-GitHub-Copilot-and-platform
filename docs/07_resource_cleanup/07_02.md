---
title: '2. Cleanup Identities (Service Principals / Federated Credentials)'
layout: default
nav_order: 2
parent: 'Exercise 07: Resource cleanup'
---

# Task 02 - Cleanup Identities (Service Principals / Federated Credentials)

## Introduction

As part of this training, you created credentials and access rights to support GitHub Actions authentication and authorization. It is critical for security and to prevent unauthorized access to remove these credentials as part of resource cleanup.

## Description

In this task be guided through steps to remove service principals, role assignments, and federated credentials that were created for GitHub Actions authentication and authorization.

## Success Criteria

- You have deleted all role assignments for service principals
- You have deleted all federated credentials have been deleted
- You have deleted all service principals created for the lab
- You have deleted the application registration (if applicable)
- You have verified that no orphaned identities remain

## Learning Resources

- [Azure CLI Reference](https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/reference)

## Key Tasks

### 01: Find service principals

First you will identify the service principals that were created by running these commands:

```powershell
# List all service principals with "github" in the name
az ad sp list --filter "startswith(displayName, 'github')" --output table

# List all service principals (more comprehensive)
az ad sp list --query "[?contains(displayName, 'github') || contains(displayName, 'zava')]" --output table

# Get specific service principal details
az ad sp show --id <service-principal-id> --output table
```

### 02: Remove role assignments

Before deleting the service principal, remove all role assignments by running these commands:

```powershell
# Get the service principal object ID
$spName = "github-actions-sp"  # or your custom name
$spId = (az ad sp list --display-name $spName --query "[0].id" -o tsv)

# List all role assignments for the service principal
az role assignment list --assignee $spId --output table

# Remove role assignments (repeat for each assignment)
az role assignment delete `
  --assignee $spId `
  --role "Contributor" `
  --scope "/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>"

az role assignment delete `
  --assignee $spId `
  --role "AcrPush" `
  --scope "/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.ContainerRegistry/registries/<acr-name>"

az role assignment delete `
  --assignee $spId `
  --role "Log Analytics Reader" `
  --scope "/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.OperationalInsights/workspaces/<workspace-name>"

# Alternative: Remove all role assignments at once
az role assignment list --assignee $spId --query "[].{Name:name, Role:roleDefinitionName, Scope:scope}" --output table | ForEach-Object {
  az role assignment delete --assignee $spId --role $_.Role --scope $_.Scope
}
```

### 03: Remove federated credentials

If you used federated credentials (OIDC) instead of service principal secrets, remove them by running these commands:

```powershell
# Get the service principal application ID
$appId = (az ad sp list --display-name "github-actions-sp" --query "[0].appId" -o tsv)

# List federated credentials
az ad app federated-credential list --id $appId --output table

# Delete each federated credential
az ad app federated-credential delete `
  --id $appId `
  --federated-credential-id <credential-id>
```

### 04: Delete the service principal

After removing all role assignments and federated credentials, you will delete the service principal. This can be done directly or through the application registration.

#### Delete with direct commands

Run one of these commands to delete the service principal:

```powershell
# Delete the service principal by display name
az ad sp delete --id "github-actions-sp"

# OR, delete by application ID
az ad sp delete --id <application-id>
```

Run the following command to verify if the deletion is complete:

```powershell
# Verify deletion
az ad sp show --id "github-actions-sp"
# This should return an error if successfully deleted
```

#### Delete via application registration

Service principals are linked to Entra ID applications. You can run the following commands to delete service principals via the application:

```powershell
# List applications
az ad app list --filter "startswith(displayName, 'github')" --output table

# Get application ID
$appId = (az ad app list --filter "displayName eq 'github-actions-sp'" --query "[0].appId" -o tsv)

# Delete the application (this also deletes the service principal)
az ad app delete --id $appId
```

Run the following command to verify if the deletion is complete:

```powershell
# Verify deletion
az ad app show --id $appId
# This should return an error if successfully deleted
```

### 05: Verify that all identities have been deleted

To verify that identities have been deleted, run the following commands:

```powershell
# Verify no service principals remain
az ad sp list --filter "startswith(displayName, 'github')" --output table

# Verify no applications remain
az ad app list --filter "startswith(displayName, 'github')" --output table

# Verify no role assignments remain (should return empty)
az role assignment list --all --output table | Select-String "github"
```

## Summary

You've completed this task. You have deleted all role assignments for service principals, deleted all federated credentials, deleted all service principals created for the lab, and verified that no orphaned identities remain.
